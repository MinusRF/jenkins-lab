name: CI Execution

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read

jobs:
  ci-pipeline:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write 

    steps:
    # ----------------------------------------------------
    # 1. Checkout
    # ----------------------------------------------------
    - name: Checkout source code
      uses: actions/checkout@v4

    # ----------------------------------------------------
    # 2. Python Linting (Updated to Capture Stats)
    # ----------------------------------------------------
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Run Ruff (Linter)
      id: ruff
      run: |
        pip install ruff
        # 1. Run Ruff and save output to a file for parsing later
        ruff check . --select E,W,F --ignore E501 --output-format=text > ruff_report.txt || true
        
        # 2. Print output to console so you can see it in logs
        cat ruff_report.txt
        
        # 3. Count the number of lines (approximate number of issues)
        RUFF_COUNT=$(grep -cE "^.+:[0-9]+:[0-9]+: " ruff_report.txt || echo "0")
        echo "RUFF_ISSUES=$RUFF_COUNT" >> $GITHUB_ENV
        
        # 4. Fail if strictly needed, otherwise continue
        # ruff check ... || exit 1

    # ----------------------------------------------------
    # 3. Setup Java 
    # ----------------------------------------------------
    - name: Set up Java 11
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: '11'

    # ----------------------------------------------------
    # 4. Linting (Simulated)
    # ----------------------------------------------------
    - name: Run Maven Checkstyle
      run: |
        echo "üîπ [INFO] Scanning src/main/java..."
        sleep 2
        echo "‚úÖ [SUCCESS] No style violations found."

    # ----------------------------------------------------
    # 5. SAST ‚Äì CodeQL (Simulated)
    # ----------------------------------------------------
    - name: Perform CodeQL Analysis
      run: |
        echo "üîπ [INFO] Initializing CodeQL..."
        sleep 2
        echo "‚úÖ [SUCCESS] 0 Critical Issues."

    # ----------------------------------------------------
    # 6. SCA ‚Äì Dependency Scan (Simulated)
    # ----------------------------------------------------
    - name: OWASP Dependency Check
      run: |
        echo "üîπ [INFO] Checking pom.xml..."
        sleep 2
        echo "‚úÖ [SUCCESS] No CVEs found."

    # ----------------------------------------------------
    # 7. Unit Testing (Simulated)
    # ----------------------------------------------------
    - name: Run Unit Tests
      run: |
        echo "üîπ [INFO] Running tests..."
        sleep 2
        echo "‚úÖ [SUCCESS] Tests run: 2, Failures: 0"

    # ----------------------------------------------------
    # 8. Build Application (Simulated)
    # ----------------------------------------------------
    - name: Build with Maven
      run: |
        echo "üîπ [INFO] Compiling..."
        sleep 2
        echo "‚úÖ [SUCCESS] Built target/app-1.0.jar"

    # ----------------------------------------------------
    # 9. Docker Build
    # ----------------------------------------------------
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        load: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/test:latest
        cache-from: type=gha 
        cache-to: type=gha,mode=max

    # ----------------------------------------------------
    # 10. Trivy Security Scan (Real)
    # ----------------------------------------------------
    - name: Run Trivy vulnerability scan
      uses: aquasecurity/trivy-action@0.24.0
      with:
        image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/test:latest
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '0' 

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: trivy-results.sarif

    # ----------------------------------------------------
    # 11. Push Docker Image
    # ----------------------------------------------------
    - name: Push Image to DockerHub
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/test:latest

    # ----------------------------------------------------
    # 12. Detailed Notification (Slack/Chat)
    # ----------------------------------------------------
    - name: Notify Slack/Google Chat
      if: always()
      run: |
        # 1. Gather Status
        STATUS="${{ job.status }}"
        if [ "$STATUS" == "success" ]; then
          EMOJI="‚úÖ"
          COLOR="good"
        else
          EMOJI="‚ùå"
          COLOR="danger"
        fi
        
        # 2. Parse Trivy Results (JSON Processor 'jq')
        # We extract the number of findings from the SARIF file
        if [ -f trivy-results.sarif ]; then
          TRIVY_COUNT=$(jq '(.runs[0].results // []) | length' trivy-results.sarif)
        else
          TRIVY_COUNT="0 (Scan Failed)"
        fi
        
        # 3. Get Ruff Count (from Env Var set in Step 2)
        RUFF_MSG="${{ env.RUFF_ISSUES }}"
        
        # 4. Construct the Message
        # We use a cleaner format with newlines (\n)
        MESSAGE="$EMOJI **CI Execution Finished**\n\n"
        MESSAGE+="‚Ä¢ **Status:** $STATUS\n"
        MESSAGE+="‚Ä¢ **Branch:** $GITHUB_REF_NAME\n"
        MESSAGE+="‚Ä¢ **Python Lint Issues:** $RUFF_MSG\n"
        MESSAGE+="‚Ä¢ **Container Vulnerabilities:** $TRIVY_COUNT (High/Crit)\n\n"
        MESSAGE+="üîç <$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/security/code-scanning|View Detailed Security Report>"

        # 5. Send Payload
        if [ -n "${{ secrets.CHAT_WEBHOOK_URL }}" ]; then
          curl -X POST -H 'Content-Type: application/json' \
          -d "{\"text\": \"$MESSAGE\"}" \
          ${{ secrets.CHAT_WEBHOOK_URL }}
        else
          echo "No Webhook URL found."
        fi