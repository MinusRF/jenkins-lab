name: CI Execution

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read

jobs:
  ci-pipeline:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write 
      actions: read

    steps:
    # ----------------------------------------------------
    # 1. Checkout (REAL)
    # ----------------------------------------------------
    - name: Checkout source code
      uses: actions/checkout@v4

    # ----------------------------------------------------
    # 2. Python Linting (REAL)
    # ----------------------------------------------------
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Run Ruff (Real Linter)
      id: ruff
      run: |
        pip install ruff
        # Run Ruff. If it finds issues, capture them but don't fail yet.
        ruff check . --select E,W,F --ignore E501 --output-format=text > ruff_report.txt || true
        
        cat ruff_report.txt
        
        # Count issues safely
        RUFF_COUNT=$(grep -cE "^.+:[0-9]+:[0-9]+: " ruff_report.txt || true)
        if [ -z "$RUFF_COUNT" ]; then RUFF_COUNT=0; fi
        echo "RUFF_ISSUES=$RUFF_COUNT" >> $GITHUB_ENV

    # ----------------------------------------------------
    # 3. SAST ‚Äì CodeQL (REAL - PYTHON)
    # ----------------------------------------------------
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: python # Changed from Java to Python

    - name: Autobuild CodeQL
      uses: github/codeql-action/autobuild@v3

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

    # ----------------------------------------------------
    # 4. SCA ‚Äì Dependency Scan (REAL - PYTHON)
    # ----------------------------------------------------
    - name: OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: "python-app"
        path: "." # Scans current folder for requirements.txt
        format: "SARIF" # SARIF allows us to upload results to GitHub
        out: "dependency-check-report"
      continue-on-error: true

    - name: Upload OWASP results to GitHub
      uses: github/codeql-action/upload-sarif@v4
      if: hashFiles('dependency-check-report/dependency-check-report.sarif') != ''
      with:
        sarif_file: dependency-check-report/dependency-check-report.sarif

    # ----------------------------------------------------
    # 5. Java Steps (SIMULATED for Teaching)
    # ----------------------------------------------------
    - name: Set up Java 11 (Simulated Setup)
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: '11'

    - name: Run Maven Checkstyle (Simulated)
      run: |
        echo "üîπ [INFO] Scanning src/main/java..."
        sleep 2
        echo "‚úÖ [SUCCESS] No style violations found."

    - name: Run Unit Tests (Simulated)
      run: |
        echo "üîπ [INFO] Running tests..."
        sleep 2
        echo "‚úÖ [SUCCESS] Tests run: 2, Failures: 0"

    - name: Build with Maven (Simulated)
      run: |
        echo "üîπ [INFO] Compiling..."
        sleep 2
        echo "‚úÖ [SUCCESS] Built target/app-1.0.jar"

    # ----------------------------------------------------
    # 6. Docker Build (REAL)
    # ----------------------------------------------------
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        load: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/test:latest
        cache-from: type=gha 
        cache-to: type=gha,mode=max

    # ----------------------------------------------------
    # 7. Trivy Security Scan (REAL)
    # ----------------------------------------------------
    - name: Run Trivy vulnerability scan
      uses: aquasecurity/trivy-action@0.24.0
      with:
        image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/test:latest
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '0' 

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v4
      if: hashFiles('trivy-results.sarif') != ''
      with:
        sarif_file: trivy-results.sarif

    # ----------------------------------------------------
    # 8. Push Docker Image (REAL)
    # ----------------------------------------------------
    - name: Push Image to DockerHub
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/test:latest

    # ----------------------------------------------------
    # 9. Notification (REAL)
    # ----------------------------------------------------
    - name: Notify Slack/Google Chat
      if: always()
      run: |
        # 1. Gather Status
        STATUS="${{ job.status }}"
        if [ "$STATUS" == "success" ]; then
          EMOJI="‚úÖ"
        else
          EMOJI="‚ùå"
        fi
        
        # 2. Parse Trivy Results
        if [ -f trivy-results.sarif ]; then
          TRIVY_COUNT=$(jq '(.runs[0].results // []) | length' trivy-results.sarif)
        else
          TRIVY_COUNT="0"
        fi
        
        # 3. Get Ruff Count
        RUFF_MSG="${{ env.RUFF_ISSUES }}"
        if [ -z "$RUFF_MSG" ]; then RUFF_MSG="0"; fi
        
        # 4. Construct Message
        MESSAGE="$EMOJI **CI Execution Finished**\n\n"
        MESSAGE+="‚Ä¢ **Status:** $STATUS\n"
        MESSAGE+="‚Ä¢ **Branch:** $GITHUB_REF_NAME\n"
        MESSAGE+="‚Ä¢ **Python Lint Issues:** $RUFF_MSG\n"
        MESSAGE+="‚Ä¢ **Container Vulnerabilities:** $TRIVY_COUNT (High/Crit)\n\n"
        MESSAGE+="üîç <$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/security/code-scanning|View Detailed Security Report>"

        # 5. Send
        if [ -n "${{ secrets.CHAT_WEBHOOK_URL }}" ]; then
          curl -X POST -H 'Content-Type: application/json' \
          -d "{\"text\": \"$MESSAGE\"}" \
          ${{ secrets.CHAT_WEBHOOK_URL }}
        else
          echo "No Webhook URL found."
        fi