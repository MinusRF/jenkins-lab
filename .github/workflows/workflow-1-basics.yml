name: CI Execution

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read

jobs:
  ci-pipeline:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write # Required for uploading security results

    steps:
    # ----------------------------------------------------
    # 1. Checkout
    # ----------------------------------------------------
    - name: Checkout source code
      uses: actions/checkout@v4

    # ----------------------------------------------------
    # 2. Python Linting (Real - Optimized)
    # ----------------------------------------------------
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Run Ruff (Linter)
      run: |
        pip install ruff
        # Checks for Errors (E), Warnings (W), Flakes (F)
        ruff check . --select E,W,F --ignore E501 || echo "Issues found (Non-blocking)"

    # ----------------------------------------------------
    # 3. Setup Java (Real Action, Simulates Build)
    # ----------------------------------------------------
    - name: Set up Java 11
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: '11'

    # ----------------------------------------------------
    # 4. Linting (Checkstyle - Simulated)
    # ----------------------------------------------------
    - name: Run Maven Checkstyle
      run: |
        echo "üîπ [INFO] Scanning src/main/java..."
        echo "üîπ [INFO] Checking code style rules..."
        sleep 2
        echo "‚úÖ [SUCCESS] No style violations found."

    # ----------------------------------------------------
    # 5. SAST ‚Äì CodeQL (Simulated)
    # ----------------------------------------------------
    - name: Perform CodeQL Analysis
      run: |
        echo "üîπ [INFO] Initializing CodeQL database..."
        echo "üîπ [INFO] Analyzing data flow..."
        sleep 3
        echo "‚úÖ [SUCCESS] Analysis complete - 0 Critical Issues."

    # ----------------------------------------------------
    # 6. SCA ‚Äì Dependency Scan (Simulated)
    # ----------------------------------------------------
    - name: OWASP Dependency Check
      run: |
        echo "üîπ [INFO] Checking pom.xml for known vulnerabilities..."
        sleep 2
        echo "‚úÖ [SUCCESS] No CVEs found in dependencies."

    # ----------------------------------------------------
    # 7. Unit Testing (Simulated)
    # ----------------------------------------------------
    - name: Run Unit Tests
      run: |
        echo "üîπ [INFO] Running tests..."
        echo "   [PASS] com.example.AppTest.testApp"
        echo "   [PASS] com.example.AuthTest.testLogin"
        sleep 2
        echo "‚úÖ [SUCCESS] Tests run: 2, Failures: 0, Errors: 0"

    # ----------------------------------------------------
    # 8. Build Application (Simulated)
    # ----------------------------------------------------
    - name: Build with Maven
      run: |
        echo "üîπ [INFO] Compiling source code..."
        echo "üîπ [INFO] Packaging artifact..."
        sleep 2
        echo "‚úÖ [SUCCESS] Built target/app-1.0.jar"

    # ----------------------------------------------------
    # 9. Docker Build (Real - Optimized)
    # ----------------------------------------------------
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false  # Don't push yet, scan first
        load: true   # Load image into local Docker for scanning
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/test:latest
        cache-from: type=gha 
        cache-to: type=gha,mode=max

    # ----------------------------------------------------
    # 10. Trivy ‚Äì Container Security Scan (Real)
    # ----------------------------------------------------
    - name: Run Trivy vulnerability scan
      uses: aquasecurity/trivy-action@0.24.0
      with:
        image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/test:latest
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '0' # Set to '1' if you want to fail build on error

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v4 # UPDATED to v4 to fix warning
      if: always()
      with:
        sarif_file: trivy-results.sarif

    # ----------------------------------------------------
    # 11. Push Docker Image
    # ----------------------------------------------------
    - name: Push Image to DockerHub
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/test:latest

    # ----------------------------------------------------
    # 12. Notifications (Slack/Chat)
    # ----------------------------------------------------
    - name: Notify Slack/Google Chat
      if: always()
      run: |
        STATUS="${{ job.status }}"
        if [ "$STATUS" == "success" ]; then
          MESSAGE="‚úÖ CI Success: Pipeline finished successfully"
        else
          MESSAGE="‚ùå CI Failure: Something went wrong. Check logs."
        fi
        
        if [ -n "${{ secrets.CHAT_WEBHOOK_URL }}" ]; then
          curl -X POST -H 'Content-Type: application/json' \
          -d "{\"text\": \"$MESSAGE\"}" \
          ${{ secrets.CHAT_WEBHOOK_URL }}
        else
          echo "No Webhook URL found, skipping notification."
        fi