name: "Workflow 2: Services & Matrix"

# Topics covered:
# - Services block
# - Matrix strategy
# - Path-based routing

on:
  push:
    paths:
      - 'app.py'
      - 'Dockerfile'
  
  workflow_dispatch:

jobs:
  # Services block example
  test-with-services:
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Test Redis Connection
        run: |
          sudo apt-get update && sudo apt-get install -y redis-tools
          redis-cli -h localhost ping
          redis-cli -h localhost SET mykey "Hello from GitHub Actions"
          redis-cli -h localhost GET mykey

  # Matrix strategy example
  matrix-build:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.8', '3.9', '3.10']
        build-type: ['dev', 'prod']
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Show Configuration
        run: |
          echo "Python: ${{ matrix.python-version }}"
          echo "Build: ${{ matrix.build-type }}"
      
      - name: Build Docker Image
        run: docker build -t app:${{ matrix.build-type }}-py${{ matrix.python-version }} .
