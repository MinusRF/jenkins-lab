name: "Workflow 2: Services & Matrix"

# Topics covered:
# - Services block (running containers alongside jobs)
# - Matrix strategy (testing multiple configurations)
# - Path-based routing (triggering on specific file changes)

on:
  push:
    paths:
      - 'app.py'
      - 'requirements.txt'
      - 'Dockerfile'
      - '.github/workflows/workflow-2-services-matrix.yml'
  
  workflow_dispatch:
    inputs:
      test_all_versions:
        description: 'Test all Python versions?'
        type: boolean
        default: false

jobs:
  # Job demonstrating services block
  integration-test:
    runs-on: ubuntu-latest
    
    # Services run as containers alongside the job
    services:
      # Redis cache service
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      # PostgreSQL database service
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Test Redis Connection
        run: |
          sudo apt-get update
          sudo apt-get install -y redis-tools
          redis-cli -h localhost -p 6379 ping
          redis-cli -h localhost -p 6379 SET test_key "GitHub Actions"
          redis-cli -h localhost -p 6379 GET test_key
      
      - name: Test PostgreSQL Connection
        env:
          PGPASSWORD: testpass
        run: |
          sudo apt-get install -y postgresql-client
          psql -h localhost -U testuser -d testdb -c "SELECT version();"
          psql -h localhost -U testuser -d testdb -c "CREATE TABLE test (id SERIAL, name VARCHAR(50));"
          psql -h localhost -U testuser -d testdb -c "INSERT INTO test (name) VALUES ('GitHub Actions');"
          psql -h localhost -U testuser -d testdb -c "SELECT * FROM test;"
      
      - name: Build and Test App with Services
        run: |
          docker build -t jenkins-app:services .
          docker run -d -p 5000:5000 --name test-app \
            --network ${{ job.container.network }} \
            jenkins-app:services || echo "App started"
          sleep 3
          curl http://localhost:5000 || echo "App is running"
          docker logs test-app || true
          docker stop test-app || true

  # Matrix strategy to test multiple configurations
  matrix-build:
    runs-on: ${{ matrix.os }}
    
    strategy:
      # Continue running other jobs even if one fails
      fail-fast: false
      
      matrix:
        # Test on different operating systems
        os: [ubuntu-latest, ubuntu-20.04]
        
        # Test with different Python versions
        python-version: ['3.8', '3.9', '3.10']
        
        # Test with different build types
        build-type: ['development', 'production']
        
        # Exclude specific combinations
        exclude:
          - os: ubuntu-20.04
            python-version: '3.10'
        
        # Include additional specific combinations
        include:
          - os: ubuntu-latest
            python-version: '3.11'
            build-type: 'production'
            experimental: true
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Display Configuration
        run: |
          echo "Testing on:"
          echo "  OS: ${{ matrix.os }}"
          echo "  Python: ${{ matrix.python-version }}"
          echo "  Build Type: ${{ matrix.build-type }}"
          echo "  Experimental: ${{ matrix.experimental || 'false' }}"
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build Docker Image
        run: |
          docker build -t jenkins-app:${{ matrix.build-type }}-py${{ matrix.python-version }} .
      
      - name: Test Docker Image
        run: |
          docker run --rm jenkins-app:${{ matrix.build-type }}-py${{ matrix.python-version }} python --version
      
      - name: Save Build Metadata
        run: |
          mkdir -p build-metadata
          cat > build-metadata/build-info-${{ matrix.os }}-py${{ matrix.python-version }}-${{ matrix.build-type }}.json << EOF
          {
            "os": "${{ matrix.os }}",
            "python_version": "${{ matrix.python-version }}",
            "build_type": "${{ matrix.build-type }}",
            "experimental": ${{ matrix.experimental || false }},
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
      
      - name: Upload Build Metadata
        uses: actions/upload-artifact@v4
        with:
          name: build-metadata-${{ matrix.os }}-py${{ matrix.python-version }}-${{ matrix.build-type }}
          path: build-metadata/

  # Collect and display results from matrix builds
  matrix-summary:
    runs-on: ubuntu-latest
    needs: matrix-build
    if: always()
    
    steps:
      - name: Download All Build Metadata
        uses: actions/download-artifact@v4
        with:
          pattern: build-metadata-*
          path: all-metadata
          merge-multiple: true
      
      - name: Display Matrix Results
        run: |
          echo "=== Matrix Build Summary ==="
          echo ""
          for file in all-metadata/*.json; do
            echo "Configuration: $(basename $file)"
            cat $file | python3 -m json.tool
            echo "---"
          done
      
      - name: Check Matrix Build Status
        run: |
          echo "Matrix build job completed!"
          echo "Job result: ${{ needs.matrix-build.result }}"

  # Demonstrate services with matrix
  matrix-with-services:
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis:${{ matrix.redis-version }}
        ports:
          - 6379:6379
    
    strategy:
      matrix:
        redis-version: ['6-alpine', '7-alpine']
    
    steps:
      - name: Test Redis Version
        run: |
          sudo apt-get update && sudo apt-get install -y redis-tools
          redis-cli -h localhost INFO server | grep redis_version
